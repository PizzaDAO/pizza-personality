import { createWalletClient, createPublicClient, http, encodeDeployData } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { base } from 'viem/chains';

// SECURITY: Never hardcode private keys! Use environment variables
const PRIVATE_KEY = process.env.DEPLOYER_PRIVATE_KEY;
if (!PRIVATE_KEY) {
  throw new Error('DEPLOYER_PRIVATE_KEY environment variable is required. Usage: DEPLOYER_PRIVATE_KEY=0x... node scripts/deploy-simple.mjs');
}

// Minimal ERC721 with mint and tokenURI - compiled from OpenZeppelin base
// This is a minimal implementation that stores URIs per token
const CONTRACT_BYTECODE = '0x608060405234801561001057600080fd5b506040518060400160405280601181526020017f50697a7a6120506572736f6e616c6974790000000000000000000000000000008152506040518060400160405280600581526020017f50495a5a410000000000000000000000000000000000000000000000000000008152508160009081610091919061030f565b5080600190816100a1919061030f565b5050506103e1565b600081519050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061012a57607f821691505b60208210810361013d5761013c6100e3565b5b50919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026101a57fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82610168565b6101af8683610168565b95508019841693508086168417925050509392505050565b6000819050919050565b6000819050919050565b60006101f66101f16101ec846101c7565b6101d1565b6101c7565b9050919050565b6000819050919050565b610210836101db565b61022461021c826101fd565b848454610175565b825550505050565b600090565b61023961022c565b610244818484610207565b505050565b5b818110156102685761025d600082610231565b60018101905061024a565b5050565b601f8211156102ad5761027e81610143565b61028784610158565b81016020851015610296578190505b6102aa6102a285610158565b830182610249565b50505b505050565b600082821c905092915050565b60006102d0600019846008026102b2565b1980831691505092915050565b60006102e983836102bf565b9150826002028217905092915050565b610302826100a9565b67ffffffffffffffff81111561031b5761031a6100b4565b5b6103258254610112565b61033082828561026c565b600060209050601f8311600181146103635760008415610351578287015190505b61035b85826102dd565b8655506103c3565b601f19841661037186610143565b60005b8281101561039957848901518255600182019150602085019450602081019050610374565b868310156103b657848901516103b2601f8916826102bf565b8355505b6001600288020188555050505b505050505050565b610c6f806103f06000396000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c80636352211e1161005b5780636352211e146100ea57806370a082311461011a578063c87b56dd1461014a578063d85d3d271461017a5761007d565b806301ffc9a71461008257806306fdde03146100b2578063095ea7b3146100d0575b600080fd5b61009c600480360381019061009791906107a4565b6101aa565b6040516100a991906107ec565b60405180910390f35b6100ba61028c565b6040516100c79190610897565b60405180910390f35b6100ea60048036038101906100e5919061094d565b61031e565b005b61010460048036038101906100ff919061098d565b610435565b60405161011191906109c9565b60405180910390f35b610134600480360381019061012f91906109e4565b6104bc565b6040516101419190610a20565b60405180910390f35b610164600480360381019061015f919061098d565b610573565b6040516101719190610897565b60405180910390f35b610194600480360381019061018f9190610a70565b610615565b6040516101a19190610a20565b60405180910390f35b60007f80ac58cd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061027557507f5b5e139f000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b80610285575061028482610692565b5b9050919050565b60606000805461029b90610aff565b80601f01602080910402602001604051908101604052809291908181526020018280546102c790610aff565b80156103145780601f106102e957610100808354040283529160200191610314565b820191906000526020600020905b8154815290600101906020018083116102f757829003601f168201915b5050505050905090565b600061032982610435565b90508073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1603610399576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161039090610ba2565b60405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff166103b86106fc565b73ffffffffffffffffffffffffffffffffffffffff1614806103e757506103e6816103e16106fc565b610704565b5b610426576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161041d90610c34565b60405180910390fd5b6104308383610798565b505050565b6000806104418361085a565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16036104b2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104a990610ca0565b60405180910390fd5b80915050919050565b60008073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff160361052c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161052390610d32565b60405180910390fd5b600360008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b606061057e82610897565b60066000838152602001908152602001600020805461059c90610aff565b80601f01602080910402602001604051908101604052809291908181526020018280546105c890610aff565b80156106155780601f106105ea57610100808354040283529160200191610615565b820191906000526020600020905b8154815290600101906020018083116105f857829003601f168201915b50505050509050919050565b6000600554905061063284826108c3565b81600660008381526020019081526020016000209081610652919061090f565b506005600081548092919061066690610a10565b919050555092915050565b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916149050919050565b600033905090565b6000600460008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16905092915050565b816003600083815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550505050565b60006002600083815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050919050565b61089c81610a5a565b6108db576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108d290610ca0565b60405180910390fd5b50565b6108cd8282604051806020016040528060008152506109e1565b600082825260208201905092915050565b7f4552433732313a20617070726f76616c20746f2063757272656e74206f776e6560008201527f7200000000000000000000000000000000000000000000000000000000000000602082015250565b600061094b6021836108f8565b915061095682610909565b604082019050919050565b6000602082019050818103600083015261097a8161093e565b9050919050565b7f4552433732313a20617070726f76652063616c6c6572206973206e6f7420746f60008201527f6b656e206f776e6572206f7220617070726f76656420666f7220616c6c000000602082015250565b60006109dd603d836108f8565b91506109e882610981565b604082019050919050565b60006020820190508181036000830152610a0c816109d0565b9050919050565b7f4552433732313a20696e76616c696420746f6b656e2049440000000000000000600082015250565b6000610a4860188361090f565b9150610a5382610a13565b602082019050919050565b60006020820190508181036000830152610a7781610a3b565b9050919050565b7f4552433732313a2061646472657373207a65726f206973206e6f74206120766160008201527f6c6964206f776e65720000000000000000000000000000000000000000000000602082015250565b6000610ad9602983610909565b9150610ae482610a7e565b604082019050919050565b60006020820190508181036000830152610b0881610acc565b9050919050565b600081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b60006002820490506001821680610b6157607f821691505b602082108103610b7457610b73610b1a565b5b50919050565b6000819050919050565b610b8d81610b7a565b82525050565b6000602082019050610ba86000830184610b84565b92915050565b600082825260208201905092915050565b6000610bca82610c93565b610bd48185610bae565b9350610be4818560208601610cb4565b610bed81610ce7565b840191505092915050565b60006020820190508181036000830152610c128184610bbf565b905092915050565b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b610c6882610c1f565b810181811067ffffffffffffffff82111715610c8757610c86610c30565b5b80604052505050565b600081519050919050565b60005b83811015610cb9578082015181840152602081019050610c9e565b60008484015250505050565b6000610cd082610c93565b610cda8185610b0f565b9350610cea818560208601610cb4565b80840191505092915050565b6000610d028284610cc5565b915081905092915050565b6000604051905090565b6000610d2282610d0d565b9050919050565b610d3281610d17565b82525050565b6000602082019050610d4d6000830184610d29565b9291505056fea2646970667358221220';

const CONTRACT_ABI = [
  {
    inputs: [
      { name: 'to', type: 'address' },
      { name: 'uri', type: 'string' },
    ],
    name: 'mint',
    outputs: [{ name: '', type: 'uint256' }],
    stateMutability: 'nonpayable',
    type: 'function',
  },
  {
    inputs: [{ name: 'tokenId', type: 'uint256' }],
    name: 'tokenURI',
    outputs: [{ name: '', type: 'string' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [],
    name: 'name',
    outputs: [{ name: '', type: 'string' }],
    stateMutability: 'view',
    type: 'function',
  },
  {
    inputs: [],
    name: 'symbol',
    outputs: [{ name: '', type: 'string' }],
    stateMutability: 'view',
    type: 'function',
  },
];

async function deploy() {
  console.log('Deploying Pizza Personality NFT to Base...\n');

  const account = privateKeyToAccount(PRIVATE_KEY);
  console.log('Deployer address:', account.address);

  const publicClient = createPublicClient({
    chain: base,
    transport: http('https://mainnet.base.org'),
  });

  const walletClient = createWalletClient({
    account,
    chain: base,
    transport: http('https://mainnet.base.org'),
  });

  // Check balance
  const balance = await publicClient.getBalance({ address: account.address });
  console.log('Balance:', (Number(balance) / 1e18).toFixed(6), 'ETH\n');

  if (balance === 0n) {
    throw new Error('No balance - please fund the wallet first');
  }

  console.log('Deploying contract...');

  // Deploy using raw transaction
  const hash = await walletClient.sendTransaction({
    data: CONTRACT_BYTECODE,
  });

  console.log('Transaction hash:', hash);
  console.log('Waiting for confirmation...\n');

  const receipt = await publicClient.waitForTransactionReceipt({ hash });

  if (receipt.contractAddress) {
    console.log('âœ… Contract deployed!');
    console.log('Contract address:', receipt.contractAddress);
    console.log('Block:', receipt.blockNumber.toString());
    console.log('\nBaseScan:', `https://basescan.org/address/${receipt.contractAddress}`);
    return receipt.contractAddress;
  } else {
    throw new Error('Contract deployment failed - no address in receipt');
  }
}

deploy()
  .then((address) => {
    console.log('\nðŸ“‹ Set this as NFT_CONTRACT_ADDRESS:', address);
  })
  .catch((error) => {
    console.error('Deployment failed:', error.message);
    process.exit(1);
  });
